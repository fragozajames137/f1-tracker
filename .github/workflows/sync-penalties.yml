name: Sync Penalty Points

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:
    inputs:
      force:
        description: "Run even outside race weekends"
        type: boolean
        default: false
      run_enrichment:
        description: "Also run FIA document enrichment"
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Race weekend check + enrichment window check (native Node.js only)
      - name: Check schedule
        id: check
        run: |
          SEASON=$(date +%Y)
          node --input-type=module -e "
            import { getRaceWeekendWindows } from './scripts/lib/race-calendar.mjs';

            const now = new Date();
            const hour = now.getUTCHours();
            const windows = await getRaceWeekendWindows($SEASON);

            let isRaceWeekend = false;
            let runEnrichment = false;
            let startWorker = false;

            for (const w of windows) {
              // Liquipedia sync: FP1 start → race end + 2h (the normal window)
              if (now >= w.windowStart && now <= w.windowEnd) {
                isRaceWeekend = true;
                console.error('Race weekend: ' + w.raceName);
              }

              // FIA enrichment: FP1 day 00:00 UTC → race day + 1 23:59 UTC
              // Only at 10:00 UTC (one run per day)
              const fp1Day = new Date(w.windowStart);
              fp1Day.setUTCHours(0, 0, 0, 0);
              const racePlusOne = new Date(w.windowEnd);
              racePlusOne.setUTCDate(racePlusOne.getUTCDate() + 1);
              racePlusOne.setUTCHours(23, 59, 59, 999);

              if (now >= fp1Day && now <= racePlusOne && hour === 10) {
                runEnrichment = true;
                console.error('FIA enrichment window: ' + w.raceName);
              }

              // Start Fly worker: 2h before FP1 through end of weekend
              const twoHoursBefore = new Date(w.windowStart.getTime() - 2 * 3600000);
              if (now >= twoHoursBefore && now <= w.windowEnd) {
                startWorker = true;
                console.error('Worker needed for: ' + w.raceName);
              }
            }

            if (!isRaceWeekend) {
              const next = windows.find(w => w.windowStart > now);
              if (next) console.error('Not race weekend. Next: ' + next.raceName + ' (' + next.windowStart.toISOString().slice(0,10) + ')');
              else console.error('No upcoming races for $SEASON');
            }

            // Write outputs
            const fs = await import('fs');
            const out = process.env.GITHUB_OUTPUT;
            fs.appendFileSync(out, 'is_race_weekend=' + isRaceWeekend + '\n');
            fs.appendFileSync(out, 'run_enrichment=' + runEnrichment + '\n');
            fs.appendFileSync(out, 'start_worker=' + startWorker + '\n');
          "

      - name: Install dependencies
        if: steps.check.outputs.is_race_weekend == 'true' || inputs.force
        run: npm ci

      - name: Sync penalty points from Liquipedia
        if: steps.check.outputs.is_race_weekend == 'true' || inputs.force
        run: node scripts/sync-penalty-points.mjs --write

      - name: Enrich with FIA documents
        if: steps.check.outputs.run_enrichment == 'true' || inputs.run_enrichment
        run: node scripts/enrich-fia-documents.mjs --sync --write

      - name: Commit and push changes
        if: steps.check.outputs.is_race_weekend == 'true' || inputs.force
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add app/data/penalty-points.json app/data/fia-decisions.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: sync penalty points [automated]"
            git push
          fi

      - name: Start Fly.io worker for race weekend
        if: steps.check.outputs.start_worker == 'true'
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          curl -sL https://fly.io/install.sh | sh
          export PATH="$HOME/.fly/bin:$PATH"
          # Start all stopped machines for the app (idempotent if already running)
          for id in $(flyctl machines list --app f1-tracker-worker --json | python3 -c "
            import json, sys
            machines = json.load(sys.stdin)
            for m in machines:
              if m.get('state') == 'stopped':
                print(m['id'])
          "); do
            echo "Starting machine $id"
            flyctl machines start "$id" --app f1-tracker-worker
          done
